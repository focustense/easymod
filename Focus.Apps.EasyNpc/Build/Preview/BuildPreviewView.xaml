<UserControl x:Class="Focus.Apps.EasyNpc.Build.Preview.BuildPreviewView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:bp="clr-namespace:Focus.Apps.EasyNpc.Build.Preview"
             xmlns:bu="clr-namespace:Focus.Apps.EasyNpc.Build.UI"
             xmlns:fa="http://schemas.fontawesome.com/icons/"
             xmlns:i="http://schemas.microsoft.com/xaml/behaviors"
             xmlns:local="clr-namespace:Focus.Apps.EasyNpc"
             xmlns:rpt="clr-namespace:Focus.Apps.EasyNpc.Reports"
             xmlns:ui="http://schemas.modernwpf.com/2019"
             mc:Ignorable="d" 
             d:DataContext="{d:DesignInstance bp:BuildPreviewViewModel}"
             d:DesignHeight="750" d:DesignWidth="1000"
             DataContextChanged="View_DataContextChanged"
             Loaded="View_Loaded">
    <UserControl.Resources>
        <Style TargetType="TextBlock" x:Key="LoweredFormLabelStyle" BasedOn="{StaticResource FormLabelStyle}">
            <Setter Property="Margin" Value="0,16,0,2"/>
        </Style>
        <Style x:Key="TooltipCellStyle" TargetType="DataGridCell" BasedOn="{StaticResource DefaultDataGridCellStyle}">
            <Setter Property="ToolTip" Value="{Binding Path=Content.Text, RelativeSource={RelativeSource Mode=Self}}"/>
        </Style>
    </UserControl.Resources>
    <Border BorderBrush="{StaticResource GroupBorderBrush}" BorderThickness="1">
        <DockPanel>
            <ListBox x:Name="SectionsListBox" DockPanel.Dock="Left">
                <ListBoxItem Selected="SectionListBoxItem_Selected"
                             PreviewMouseLeftButtonDown="SectionListBoxItem_PreviewMouseLeftButtonDown">Summary</ListBoxItem>
                <ListBoxItem Selected="SectionListBoxItem_Selected"
                             PreviewMouseLeftButtonDown="SectionListBoxItem_PreviewMouseLeftButtonDown"
                             Tag="{Binding ElementName=NpcsExpander}">NPCs</ListBoxItem>
                <ListBoxItem Selected="SectionListBoxItem_Selected"
                             PreviewMouseLeftButtonDown="SectionListBoxItem_PreviewMouseLeftButtonDown"
                             Tag="{Binding ElementName=PluginsExpander}">Plugins</ListBoxItem>
                <ListBoxItem Selected="SectionListBoxItem_Selected"
                             PreviewMouseLeftButtonDown="SectionListBoxItem_PreviewMouseLeftButtonDown"
                             Tag="{Binding ElementName=AssetsExpander}">Resources</ListBoxItem>
                <ListBoxItem Selected="SectionListBoxItem_Selected"
                             PreviewMouseLeftButtonDown="SectionListBoxItem_PreviewMouseLeftButtonDown"
                             Tag="{Binding ElementName=AlertsExpander}">Alerts</ListBoxItem>
                <ListBoxItem Selected="SectionListBoxItem_Selected"
                             PreviewMouseLeftButtonDown="SectionListBoxItem_PreviewMouseLeftButtonDown"
                             Tag="{Binding ElementName=OutputExpander}">Output</ListBoxItem>
            </ListBox>
            <Rectangle DockPanel.Dock="Left" Width="1" Fill="{StaticResource SystemControlBackgroundBaseLowBrush}"/>
            <ScrollViewer x:Name="ContentScrollViewer"
                          ScrollChanged="ContentScrollViewer_ScrollChanged"
                          local:ScrollAnimation.TimeDuration="00:00:00.400">
                <ui:SimpleStackPanel Margin="0,0,8,0">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="*"/>
                        </Grid.ColumnDefinitions>
                        <rpt:SummaryGroup Grid.Column="0" Items="{Binding Npcs.SummaryItems}" Margin="8" Title="NPCs"/>
                        <rpt:SummaryGroup Grid.Column="1" Items="{Binding Plugins.SummaryItems}" Margin="8" Title="Plugins"/>
                        <rpt:SummaryGroup Grid.Column="2" Margin="8" Title="Alerts">
                            <rpt:SummaryGroup.Items>
                                <MultiBinding Converter="{StaticResource ConcatSequences}">
                                    <Binding Path="Alerts.HeaderSummaryItems"/>
                                    <Binding Path="Assets.AlertSummaryItems"/>
                                    <Binding Path="Alerts.MainSummaryItems"/>
                                </MultiBinding>
                            </rpt:SummaryGroup.Items>
                        </rpt:SummaryGroup>
                        <rpt:SummaryGroup Grid.Column="3" Margin="8" Title="Output">
                            <rpt:SummaryGroup.Items>
                                <MultiBinding Converter="{StaticResource ConcatSequences}">
                                    <Binding Path="Output.SummaryItems"/>
                                    <Binding Path="Assets.SummaryItems"/>
                                </MultiBinding>
                            </rpt:SummaryGroup.Items>
                        </rpt:SummaryGroup>
                    </Grid>
                    <Border Background="{StaticResource HelpPanelBackgroundBrush}"
                            BorderBrush="{StaticResource GroupBorderBrush}"
                            BorderThickness="1"
                            CornerRadius="8"
                            Margin="8,0,8,8"
                            Padding="12,8">
                        <DockPanel>
                            <Button x:Name="BuildButton"
                                    DockPanel.Dock="Right"
                                    IsEnabled="{Binding OverallErrorLevel, Converter={StaticResource NotEqual}, ConverterParameter={x:Static bp:ErrorLevel.Fatal}}"
                                    Style="{StaticResource AccentButtonStyle}"
                                    Click="BuildButton_Click">
                                <ui:SimpleStackPanel Orientation="Horizontal">
                                    <fa:SvgAwesome Foreground="{StaticResource SystemControlForegroundAltHighBrush}"
                                                   Icon="Solid_Cogs"
                                                   Height="16"
                                                   Margin="0,0,8,0"
                                                   VerticalAlignment="Center"/>
                                    <TextBlock Visibility="{Binding OverallErrorLevel, Converter={StaticResource HiddenWhen}, ConverterParameter={x:Static bp:ErrorLevel.Warning}}">
                                        Build
                                    </TextBlock>
                                    <TextBlock Visibility="{Binding OverallErrorLevel, Converter={StaticResource VisibleWhen}, ConverterParameter={x:Static bp:ErrorLevel.Warning}}">
                                        Build Anyway
                                    </TextBlock>
                                </ui:SimpleStackPanel>
                            </Button>
                            <TextBlock Style="{StaticResource BodyTextBlockStyle}"
                                       VerticalAlignment="Center"
                                       Visibility="{Binding OverallErrorLevel, Converter={StaticResource VisibleWhen}, ConverterParameter={x:Static bp:ErrorLevel.Fatal}}">
                                Building is disabled until
                                <fa:SvgAwesome Foreground="{StaticResource SystemControlErrorTextForegroundBrush}"
                                               Height="{Binding FontSize, RelativeSource={RelativeSource AncestorType=TextBlock}}"
                                               Margin="0,0,0,-2"
                                               Icon="Solid_TimesCircle"/>
                                <Run FontWeight="SemiBold" Foreground="{StaticResource SystemControlErrorTextForegroundBrush}">critical errors</Run> are resolved.
                            </TextBlock>
                            <TextBlock Style="{StaticResource BodyTextBlockStyle}"
                                       VerticalAlignment="Center"
                                       Visibility="{Binding OverallErrorLevel, Converter={StaticResource VisibleWhen}, ConverterParameter={x:Static bp:ErrorLevel.Warning}}">
                                Building is <Run FontWeight="SemiBold">not recommended</Run> until all
                                <fa:SvgAwesome Foreground="{StaticResource WarningForegroundBrush}"
                                               Height="{Binding FontSize, RelativeSource={RelativeSource AncestorType=TextBlock}}"
                                               Margin="2,0,0,-2"
                                               Icon="Solid_ExclamationTriangle"/>
                                <Run FontWeight="SemiBold" Foreground="{StaticResource WarningForegroundBrush}">warnings</Run>
                                have been cleared or confirmed as acceptable.
                            </TextBlock>
                            <TextBlock Style="{StaticResource BodyTextBlockStyle}"
                                       VerticalAlignment="Center"
                                       Visibility="{Binding HasErrorsOrWarnings, Converter={StaticResource InvBoolToVisibility}}">
                                Ready to build.
                            </TextBlock>
                        </DockPanel>
                    </Border>
                    <Separator Margin="8,4,8,4" Height="4"/>
                    <Expander x:Name="NpcsExpander" IsExpanded="{Binding IsNpcsExpanded}" Margin="8" d:IsExpanded="False">
                        <Expander.Header>
                            <TextBlock FontSize="18">NPC Details</TextBlock>
                        </Expander.Header>
                        <ui:SimpleStackPanel>
                            <ui:SimpleStackPanel Margin="0,4,0,8" Orientation="Horizontal">
                                <ui:SimpleStackPanel.Resources>
                                    <Style TargetType="RadioButton" BasedOn="{StaticResource {x:Type ToggleButton}}">
                                        <Setter Property="MinWidth" Value="80"/>
                                    </Style>
                                    <Style x:Key="Separator" TargetType="Rectangle">
                                        <Setter Property="Fill" Value="{StaticResource SystemControlBackgroundBaseMediumLowBrush}"/>
                                        <Setter Property="VerticalAlignment" Value="Stretch"/>
                                        <Setter Property="Width" Value="1"/>
                                    </Style>
                                </ui:SimpleStackPanel.Resources>
                                <RadioButton GroupName="NpcFilter"
                                             IsChecked="{Binding Npcs.Filter, Converter={StaticResource Equals}, ConverterParameter={x:Static bp:NpcSummaryFilter.All}}"
                                             local:BorderProperties.CornerRadius="8,0,0,8">All</RadioButton>
                                <Rectangle Style="{StaticResource Separator}"/>
                                <RadioButton GroupName="NpcFilter"
                                             IsChecked="{Binding Npcs.Filter, Converter={StaticResource Equals}, ConverterParameter={x:Static bp:NpcSummaryFilter.Modded}}"
                                             local:BorderProperties.CornerRadius="0">Modded</RadioButton>
                                <Rectangle Style="{StaticResource Separator}"/>
                                <RadioButton GroupName="NpcFilter"
                                             IsChecked="{Binding Npcs.Filter, Converter={StaticResource Equals}, ConverterParameter={x:Static bp:NpcSummaryFilter.Ignored}}"
                                             local:BorderProperties.CornerRadius="0">Ignored</RadioButton>
                                <Rectangle Style="{StaticResource Separator}"/>
                                <RadioButton GroupName="NpcFilter"
                                             IsChecked="{Binding Npcs.Filter, Converter={StaticResource Equals}, ConverterParameter={x:Static bp:NpcSummaryFilter.Unmodded}}"
                                             local:BorderProperties.CornerRadius="0">Vanilla</RadioButton>
                                <Rectangle Style="{StaticResource Separator}"/>
                                <RadioButton GroupName="NpcFilter"
                                             IsChecked="{Binding Npcs.Filter, Converter={StaticResource Equals}, ConverterParameter={x:Static bp:NpcSummaryFilter.Unmoddable}}"
                                             local:BorderProperties.CornerRadius="0,8,8,0">Unmoddable</RadioButton>
                            </ui:SimpleStackPanel>
                            <Border BorderBrush="{StaticResource SystemControlBackgroundChromeMediumBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4,4,0,0"
                                    Padding="8">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Setter Property="Background" Value="{StaticResource NpcFilterAllBackgroundBrush}"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Npcs.Filter}" Value="Modded">
                                                <Setter Property="Background" Value="{StaticResource NpcFilterModdedBackgroundBrush}"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Npcs.Filter}" Value="Ignored">
                                                <Setter Property="Background" Value="{StaticResource NpcFilterIgnoredBackgroundBrush}"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Npcs.Filter}" Value="Unmodded">
                                                <Setter Property="Background" Value="{StaticResource NpcFilterUnmoddedBackgroundBrush}"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Npcs.Filter}" Value="Unmoddable">
                                                <Setter Property="Background" Value="{StaticResource NpcFilterUnmoddableBackgroundBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <Grid>
                                    <Grid Visibility="{Binding Npcs.Filter, Converter={StaticResource VisibleWhen}, ConverterParameter={x:Static bp:NpcSummaryFilter.All}}">
                                        <Grid.Resources>
                                            <Style x:Key="LegendBorder" TargetType="Border">
                                                <Setter Property="CornerRadius" Value="4"/>
                                                <Setter Property="Margin" Value="8,-4,0,-4"/>
                                                <Setter Property="Padding" Value="8,4"/>
                                                <Setter Property="VerticalAlignment" Value="Center"/>
                                            </Style>
                                            <Style x:Key="LegendText" TargetType="TextBlock" BasedOn="{StaticResource CaptionTextBlockStyle}">
                                                <Setter Property="FontWeight" Value="SemiBold"/>
                                                <Setter Property="Foreground" Value="{StaticResource MutedTextBrush}"/>
                                            </Style>
                                        </Grid.Resources>
                                        <Grid.ColumnDefinitions>
                                            <ColumnDefinition Width="Auto"/>
                                            <ColumnDefinition Width="*"/>
                                        </Grid.ColumnDefinitions>
                                        <TextBlock Foreground="{StaticResource MutedTextBrush}"
                                                   Grid.Column="0"
                                                   Style="{StaticResource CaptionTextBlockStyle}"
                                                   TextWrapping="Wrap"
                                                   VerticalAlignment="Center">
                                            Showing all NPCs from every category. Click any of the tabs above to filter.
                                        </TextBlock>
                                        <ui:SimpleStackPanel Grid.Column="1" HorizontalAlignment="Right" Orientation="Horizontal">
                                            <Border Background="{StaticResource NpcFilterModdedBackgroundBrush}" Style="{StaticResource LegendBorder}">
                                                <TextBlock Style="{StaticResource LegendText}">Modded</TextBlock>
                                            </Border>
                                            <Border Background="{StaticResource NpcFilterIgnoredBackgroundBrush}" Style="{StaticResource LegendBorder}">
                                                <TextBlock Style="{StaticResource LegendText}">Ignored</TextBlock>
                                            </Border>
                                            <Border Background="{StaticResource NpcFilterUnmoddedBackgroundBrush}" Style="{StaticResource LegendBorder}">
                                                <TextBlock Style="{StaticResource LegendText}">Vanilla</TextBlock>
                                            </Border>
                                            <Border Background="{StaticResource NpcFilterUnmoddableBackgroundBrush}" Style="{StaticResource LegendBorder}">
                                                <TextBlock Style="{StaticResource LegendText}">Unmoddable</TextBlock>
                                            </Border>
                                        </ui:SimpleStackPanel>
                                    </Grid>
                                    <TextBlock Foreground="{StaticResource MutedTextBrush}"
                                               Style="{StaticResource CaptionTextBlockStyle}"
                                               TextWrapping="Wrap"
                                               Visibility="{Binding Npcs.Filter, Converter={StaticResource VisibleWhen}, ConverterParameter={x:Static bp:NpcSummaryFilter.Modded}}">
                                        Modded NPCs are being managed by <Run Text="{StaticResource AppName}"/> and will appear in the plugin/facegen output.
                                    </TextBlock>
                                    <TextBlock Foreground="{StaticResource MutedTextBrush}"
                                               Style="{StaticResource CaptionTextBlockStyle}"
                                               TextWrapping="Wrap"
                                               Visibility="{Binding Npcs.Filter, Converter={StaticResource VisibleWhen}, ConverterParameter={x:Static bp:NpcSummaryFilter.Ignored}}">
                                        Ignored NPCs have been manually excluded from your profile.
                                    </TextBlock>
                                    <TextBlock Foreground="{StaticResource MutedTextBrush}"
                                               Style="{StaticResource CaptionTextBlockStyle}"
                                               TextWrapping="Wrap"
                                               Visibility="{Binding Npcs.Filter, Converter={StaticResource VisibleWhen}, ConverterParameter={x:Static bp:NpcSummaryFilter.Unmodded}}">
                                        Unmodded NPCs can potentially be managed by <Run Text="{StaticResource AppName}"/>, but are not currently covered by any installed mods.
                                    </TextBlock>
                                    <TextBlock Foreground="{StaticResource MutedTextBrush}"
                                               Style="{StaticResource CaptionTextBlockStyle}"
                                               TextWrapping="Wrap"
                                               Visibility="{Binding Npcs.Filter, Converter={StaticResource VisibleWhen}, ConverterParameter={x:Static bp:NpcSummaryFilter.Unmoddable}}">
                                        Unmoddable NPCs can't be modded by <Run Text="{StaticResource AppName}"/>, either due to current limitations of
                                        <Run Text="{StaticResource AppName}"/> (e.g. Children) or a limitation of the game engine itself (template NPCs, non-human races, etc.)
                                    </TextBlock>
                                </Grid>
                            </Border>
                            <DataGrid AutoGenerateColumns="False"
                                      HeadersVisibility="Column"
                                      IsReadOnly="True"
                                      ItemsSource="{Binding Npcs.FilteredRows}"
                                      MaxHeight="{Binding ElementName=ContentScrollViewer, Path=ActualHeight, Converter={StaticResource Math}, ConverterParameter='max(x-250,200)'}"
                                      SelectedItem="{Binding Npcs.SelectedRow}"
                                      SelectionMode="Single"
                                      local:ForceTextTrimming.ForceTextTrimming="CharacterEllipsis"
                                      MouseDoubleClick="NpcGrid_MouseDoubleClick">
                                <i:Interaction.Behaviors>
                                    <local:ScrollRestoreBehavior Key="PreBuild_Npcs"/>
                                    <local:WheelBubblingBehavior/>
                                </i:Interaction.Behaviors>
                                <DataGrid.Columns>
                                    <DataGridTextColumn Binding="{Binding BasePluginName}" CellStyle="{StaticResource TooltipCellStyle}" Header="Base Plugin" Width="150"/>
                                    <DataGridTextColumn Binding="{Binding LocalFormIdHex}" CellStyle="{StaticResource TooltipCellStyle}" Header="Form ID" Width="100"/>
                                    <DataGridTextColumn Binding="{Binding EditorId}" CellStyle="{StaticResource TooltipCellStyle}"  Header="Editor ID" Width="150"/>
                                    <DataGridTextColumn Binding="{Binding Name}" CellStyle="{StaticResource TooltipCellStyle}"  Header="Full Name" Width="*"/>
                                    <DataGridTextColumn Binding="{Binding DefaultPluginName}" CellStyle="{StaticResource TooltipCellStyle}"  Header="Default Plugin" Width="150"/>
                                    <DataGridTextColumn Binding="{Binding FacePluginName}" CellStyle="{StaticResource TooltipCellStyle}"  Header="Face Plugin" Width="150"/>
                                    <DataGridTextColumn Binding="{Binding FaceGenModName}" CellStyle="{StaticResource TooltipCellStyle}"  Header="FaceGen Override" Width="150"/>
                                </DataGrid.Columns>
                                <DataGrid.RowStyle>
                                    <Style TargetType="DataGridRow" BasedOn="{StaticResource DefaultDataGridRowStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Filter}" Value="Modded">
                                                <Setter Property="Background" Value="{StaticResource NpcFilterModdedBackgroundBrush}"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Filter}" Value="Ignored">
                                                <Setter Property="Background" Value="{StaticResource NpcFilterIgnoredBackgroundBrush}"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Filter}" Value="Unmodded">
                                                <Setter Property="Background" Value="{StaticResource NpcFilterUnmoddedBackgroundBrush}"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Filter}" Value="Unmoddable">
                                                <Setter Property="Background" Value="{StaticResource NpcFilterUnmoddableBackgroundBrush}"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding RelativeSource={RelativeSource AncestorType=DataGrid},
                                                                           Path=DataContext.Npcs.Filter,
                                                                           Converter={StaticResource Equals},
                                                                           ConverterParameter={x:Static bp:NpcSummaryFilter.All}}"
                                                         Value="False">
                                                <Setter Property="Background" Value="Transparent"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </DataGrid.RowStyle>
                            </DataGrid>
                        </ui:SimpleStackPanel>
                    </Expander>
                    <Expander x:Name="PluginsExpander" IsExpanded="{Binding IsPluginsExpanded}" Margin="8" d:IsExpanded="False">
                        <Expander.Header>
                            <TextBlock FontSize="18">Master Details</TextBlock>
                        </Expander.Header>
                        <ui:SimpleStackPanel Margin="0,4,0,0">
                            <Border Background="{StaticResource HelpPanelBackgroundBrush}"
                                    BorderBrush="{StaticResource SystemControlBackgroundChromeMediumBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4,4,0,0"
                                    Padding="8"
                                    Visibility="{Binding Plugins.HasSuspiciousMasters, Converter={StaticResource BoolToVisibility}}">
                                <ui:SimpleStackPanel Orientation="Vertical">
                                    <TextBlock Foreground="{StaticResource MutedTextBrush}" Style="{StaticResource CaptionTextBlockStyle}" TextWrapping="Wrap">
                                        <Run Foreground="{StaticResource SystemControlErrorTextForegroundBrush}">Suspicious masters</Run> are plugins that
                                        <Run Text="{StaticResource AppName}"/> has identified as "probably" being either an NPC overhaul, or a patch for one. Each of these is a
                                        master because at least one NPC uses it as the <Run FontStyle="Italic">Default Plugin</Run> setting. To see which ones, double-click on
                                        the row below, or use the NPCs grid above and sort by the Default Plugin. You won't be able to deactivate any of these plugins/mods after
                                        building unless they are eliminated as masters.
                                    </TextBlock>
                                    <TextBlock Foreground="{StaticResource MutedTextBrush}" Margin="0,8,0,0" Style="{StaticResource CaptionTextBlockStyle}" TextWrapping="Wrap">
                                        Detection of overhauls may not be 100% accurate. It is always recommended to review the entire list below, and eliminate any plugins
                                        that you personally recognize as NPC overhauls, regardless of whether <Run Text="{StaticResource AppName}"/> has flagged them as
                                        suspicious. <Run FontWeight="SemiBold">Master dependencies can be indirect</Run>, so it is best to
                                        <Run FontWeight="SemiBold">start from the bottom and work your way up.</Run>
                                    </TextBlock>
                                </ui:SimpleStackPanel>
                            </Border>
                            <DataGrid AutoGenerateColumns="False"
                                      HeadersVisibility="Column"
                                      IsReadOnly="True"
                                      ItemsSource="{Binding Plugins.MasterPlugins.Values}"
                                      MaxHeight="{Binding ElementName=ContentScrollViewer, Path=ActualHeight, Converter={StaticResource Math}, ConverterParameter='max(x-250,200)'}"
                                      SelectedItem="{Binding Plugins.SelectedPlugin}"
                                      SelectionMode="Single"
                                      local:ForceTextTrimming.ForceTextTrimming="CharacterEllipsis"
                                      MouseDoubleClick="PluginGrid_MouseDoubleClick">
                                <i:Interaction.Behaviors>
                                    <local:ScrollRestoreBehavior Key="PreBuild_Plugins"/>
                                    <local:WheelBubblingBehavior/>
                                </i:Interaction.Behaviors>
                                <DataGrid.Columns>
                                    <DataGridTextColumn Binding="{Binding PluginName}" CellStyle="{StaticResource TooltipCellStyle}" Header="Plugin Name" Width="300"/>
                                    <DataGridTextColumn Binding="{Binding Component.ModKey.Name}" CellStyle="{StaticResource TooltipCellStyle}" Header="Providing Mod" Width="*"/>
                                    <DataGridTextColumn Binding="{Binding CategoryDescription}" CellStyle="{StaticResource TooltipCellStyle}" Header="Category" Width="200"/>
                                </DataGrid.Columns>
                                <DataGrid.RowStyle>
                                    <Style TargetType="DataGridRow" BasedOn="{StaticResource DefaultDataGridRowStyle}">
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding IsSuspiciousMaster}" Value="True">
                                                <Setter Property="Background" Value="{StaticResource NpcFilterUnmoddableBackgroundBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </DataGrid.RowStyle>
                            </DataGrid>
                        </ui:SimpleStackPanel>
                    </Expander>
                    <Expander x:Name="AssetsExpander" IsExpanded="{Binding IsAssetsExpanded}" Margin="8" d:IsExpanded="False">
                        <Expander.Header>
                            <TextBlock FontSize="18">Resources</TextBlock>
                        </Expander.Header>
                        <Grid>
                            <Border Background="{StaticResource NpcFilterModdedBackgroundBrush}"
                                    BorderBrush="{StaticResource GroupBorderBrush}"
                                    BorderThickness="1"
                                    CornerRadius="4"
                                    Margin="0,4,0,0"
                                    Padding="8"
                                    Visibility="{Binding Assets.HasMissingAssets, Converter={StaticResource InvBoolToVisibility}}">
                                <TextBlock TextWrapping="Wrap">
                                    <Run FontWeight="SemiBold">You're all good!</Run> All of the resource files (meshes, textures, etc.) required by your chosen NPC overhauls are
                                    present and accounted for.
                                </TextBlock>
                            </Border>
                            <ui:SimpleStackPanel Margin="0,4,0,0"
                                                 Visibility="{Binding Assets.HasMissingAssets, Converter={StaticResource BoolToVisibility}}">
                                <Border Background="{StaticResource HelpPanelBackgroundBrush}"
                                        BorderBrush="{StaticResource SystemControlBackgroundChromeMediumBrush}"
                                        BorderThickness="1"
                                        CornerRadius="4,4,0,0"
                                        Padding="8">
                                    <TextBlock Foreground="{StaticResource MutedTextBrush}" Style="{StaticResource CaptionTextBlockStyle}" TextWrapping="Wrap">
                                        Your current profile references <Run Foreground="{StaticResource SystemControlErrorTextForegroundBrush}">missing assets</Run>.
                                        <Run Text="{StaticResource AppName}"/> can't find these files anywhere in your game data or loaded archives, and the NPCs which
                                        reference them - even indirectly - may not have the expected appearance, or in severe cases may crash the game. Refer to the list
                                        below for details.
                                    </TextBlock>
                                </Border>
                                <DataGrid x:Name="MissingAssetsGrid"
                                          AutoGenerateColumns="False"
                                          HeadersVisibility="Column"
                                          IsReadOnly="True"
                                          ItemsSource="{Binding Assets.MissingAssets}"
                                          MaxHeight="{Binding ElementName=ContentScrollViewer, Path=ActualHeight, Converter={StaticResource Math}, ConverterParameter='max(x-250,200)'}"
                                          SelectedItem="{Binding Assets.SelectedMissingAsset}"
                                          SelectionMode="Single"
                                          ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                                          local:ForceTextTrimming.ForceTextTrimming="CharacterEllipsis">
                                    <i:Interaction.Behaviors>
                                        <local:ScrollRestoreBehavior Key="PreBuild_MissingAssets"/>
                                        <local:WheelBubblingBehavior/>
                                    </i:Interaction.Behaviors>
                                    <DataGrid.Columns>
                                        <DataGridTextColumn Binding="{Binding Kind}" CellStyle="{StaticResource TooltipCellStyle}" Header="Type" Width="100"/>
                                        <DataGridTextColumn Binding="{Binding NormalizedPath}" CellStyle="{StaticResource TooltipCellStyle}" Header="File Name" Width="*"/>
                                    </DataGrid.Columns>
                                    <DataGrid.RowDetailsTemplate>
                                        <DataTemplate>
                                            <Border Padding="8">
                                                <ui:SimpleStackPanel>
                                                    <TextBlock Style="{StaticResource BodyTextBlockStyle}">NPCs using this resource:</TextBlock>
                                                    <DataGrid AutoGenerateColumns="False"
                                                              HeadersVisibility="Column"
                                                              IsReadOnly="True"
                                                              ItemsSource="{Binding ReferencedByNpcs}"
                                                              Margin="0,8,0,0"
                                                              MaxHeight="{Binding ElementName=MissingAssetsGrid, Path=ActualHeight, Converter={StaticResource Math}, ConverterParameter='x/2'}"
                                                              SelectionMode="Single"
                                                              local:ForceTextTrimming.ForceTextTrimming="CharacterEllipsis"
                                                              MouseDoubleClick="NpcGrid_MouseDoubleClick">
                                                        <i:Interaction.Behaviors>
                                                            <local:ScrollRestoreBehavior Key="{Binding ScrollKey}"/>
                                                            <local:WheelBubblingBehavior/>
                                                        </i:Interaction.Behaviors>
                                                        <DataGrid.Columns>
                                                            <DataGridTextColumn Binding="{Binding BasePluginName}" CellStyle="{StaticResource TooltipCellStyle}" Header="Base Plugin" Width="180"/>
                                                            <DataGridTextColumn Binding="{Binding LocalFormIdHex}" CellStyle="{StaticResource TooltipCellStyle}" Header="Form ID" Width="100"/>
                                                            <DataGridTextColumn Binding="{Binding EditorId}" CellStyle="{StaticResource TooltipCellStyle}"  Header="Editor ID" Width="180"/>
                                                            <DataGridTextColumn Binding="{Binding Name}" CellStyle="{StaticResource TooltipCellStyle}"  Header="Full Name" Width="*"/>
                                                            <DataGridTextColumn Binding="{Binding FaceOption.PluginName}" CellStyle="{StaticResource TooltipCellStyle}"  Header="Plugin" Width="250"/>
                                                        </DataGrid.Columns>
                                                    </DataGrid>
                                                </ui:SimpleStackPanel>
                                            </Border>
                                        </DataTemplate>
                                    </DataGrid.RowDetailsTemplate>
                                </DataGrid>
                            </ui:SimpleStackPanel>
                        </Grid>
                    </Expander>
                    <Expander x:Name="AlertsExpander" IsExpanded="{Binding IsAlertsExpanded}" Margin="8" d:IsExpanded="False">
                        <Expander.Header>
                            <TextBlock FontSize="18">Alert Details</TextBlock>
                        </Expander.Header>
                        <ui:SimpleStackPanel Margin="0,4,0,0">
                            <ListBox x:Name="WarningsListBox"
                                     Background="{StaticResource SystemControlPageBackgroundTransparentBrush}"
                                     BorderBrush="{StaticResource GroupBorderBrush}"
                                     BorderThickness="1"
                                     ItemsSource="{Binding Alerts.Warnings}"
                                     MaxHeight="300"
                                     SelectedItem="{Binding Alerts.SelectedWarning}"
                                     ScrollViewer.VerticalScrollBarVisibility="Visible"
                                     MouseDoubleClick="WarningsListBox_MouseDoubleClick">
                                <i:Interaction.Behaviors>
                                    <local:ScrollRestoreBehavior Key="PreBuild_Warnings"/>
                                    <local:WheelBubblingBehavior/>
                                </i:Interaction.Behaviors>
                                <ListBox.ItemContainerStyle>
                                    <Style TargetType="ListBoxItem" BasedOn="{StaticResource {x:Type ListBoxItem}}">
                                        <Setter Property="HorizontalAlignment" Value="Stretch"/>
                                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                                        <Setter Property="Padding" Value="12,0,8,0"/>
                                        <Style.Triggers>
                                            <DataTrigger Binding="{Binding Severity}" Value="High">
                                                <Setter Property="Background" Value="{StaticResource NpcFilterUnmoddableBackgroundBrush}"/>
                                            </DataTrigger>
                                            <DataTrigger Binding="{Binding Severity}" Value="Medium">
                                                <Setter Property="Background" Value="{StaticResource NpcFilterUnmoddedBackgroundBrush}"/>
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </ListBox.ItemContainerStyle>
                                <ListBox.ItemTemplate>
                                    <DataTemplate>
                                        <ui:SimpleStackPanel>
                                            <Rectangle Fill="{StaticResource GroupBorderBrush}" Height="1" HorizontalAlignment="Stretch" Margin="-12,0">
                                                <Rectangle.Style>
                                                    <Style TargetType="Rectangle">
                                                        <Style.Triggers>
                                                            <DataTrigger Binding="{Binding RelativeSource={RelativeSource PreviousData}}" Value="{x:Null}">
                                                                <Setter Property="Visibility" Value="Collapsed"/>
                                                            </DataTrigger>
                                                        </Style.Triggers>
                                                    </Style>
                                                </Rectangle.Style>
                                            </Rectangle>
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>
                                                <ui:SimpleStackPanel Orientation="Horizontal">
                                                    <fa:SvgAwesome Height="16" Margin="0,0,8,0">
                                                        <fa:SvgAwesome.Style>
                                                            <Style TargetType="fa:SvgAwesome">
                                                                <Setter Property="Foreground" Value="{StaticResource HelpIconForegroundBrush}"/>
                                                                <Setter Property="Icon" Value="Solid_InfoCircle"/>
                                                                <Style.Triggers>
                                                                    <DataTrigger Binding="{Binding Severity}" Value="High">
                                                                        <Setter Property="Foreground" Value="{StaticResource SystemControlErrorTextForegroundBrush}"/>
                                                                        <Setter Property="Icon" Value="Regular_TimesCircle"/>
                                                                    </DataTrigger>
                                                                    <DataTrigger Binding="{Binding Severity}" Value="Medium">
                                                                        <Setter Property="Foreground" Value="{StaticResource WarningForegroundBrush}"/>
                                                                        <Setter Property="Icon" Value="Solid_ExclamationTriangle"/>
                                                                    </DataTrigger>
                                                                </Style.Triggers>
                                                            </Style>
                                                        </fa:SvgAwesome.Style>
                                                    </fa:SvgAwesome>
                                                    <TextBlock Grid.Column="0" Margin="0,8" Text="{Binding Message}"/>
                                                </ui:SimpleStackPanel>
                                                <Border Background="{StaticResource SystemControlBackgroundAltMediumHighBrush}" CornerRadius="2" Grid.Column="1" Height="24" Margin="6" Width="24">
                                                    <Button HorizontalAlignment="Stretch" Padding="6" VerticalAlignment="Stretch">
                                                        <fa:SvgAwesome Icon="Solid_Question" VerticalAlignment="Stretch"/>
                                                        <ui:FlyoutService.Flyout>
                                                            <ui:Flyout Placement="Left" >
                                                                <ui:Flyout.FlyoutPresenterStyle>
                                                                    <Style TargetType="ui:FlyoutPresenter">
                                                                        <Setter Property="Background" Value="{StaticResource HelpPanelBackgroundBrush}"/>
                                                                        <Setter Property="FontSize" Value="12"/>
                                                                    </Style>
                                                                </ui:Flyout.FlyoutPresenterStyle>
                                                                <bu:BuildWarningHelp Width="400"/>
                                                            </ui:Flyout>
                                                        </ui:FlyoutService.Flyout>
                                                    </Button>
                                                </Border>
                                            </Grid>
                                        </ui:SimpleStackPanel>
                                    </DataTemplate>
                                </ListBox.ItemTemplate>
                            </ListBox>
                        </ui:SimpleStackPanel>
                    </Expander>
                    <Expander x:Name="OutputExpander" IsExpanded="{Binding IsOutputExpanded}" Margin="8" d:IsExpanded="False">
                        <Expander.Header>
                            <TextBlock FontSize="18">Output Settings</TextBlock>
                        </Expander.Header>
                        <Border BorderBrush="{StaticResource GroupBorderBrush}" BorderThickness="1" Padding="8,0,8,8" Margin="0,4,0,0">
                            <ui:SimpleStackPanel>
                                <TextBlock Text="Mod Name" Style="{StaticResource FormLabelStyle}"/>
                                <TextBox Text="{Binding Output.ModName, UpdateSourceTrigger=PropertyChanged}"/>
                                <ui:SimpleStackPanel Orientation="Horizontal" Visibility="{Binding Output.IsExistingMod, Converter={StaticResource BoolToVisibility}}">
                                    <fa:SvgAwesome Foreground="{StaticResource SystemControlErrorTextForegroundBrush}" Icon="Solid_ExclamationTriangle" Width="10" Height="10"/>
                                    <TextBlock Foreground="{StaticResource SystemControlErrorTextForegroundBrush}" Text="Mod already exists" Margin="4,0,0,0"/>
                                </ui:SimpleStackPanel>
                                <TextBlock Foreground="{StaticResource SystemControlForegroundBaseMediumBrush}" Style="{StaticResource CaptionTextBlockStyle}">
                                    Please specify a <Bold>new or empty</Bold> mod. Existing files can interfere with the merge and may also be overwritten or deleted.
                                </TextBlock>
                                <ui:SimpleStackPanel Orientation="Horizontal">
                                    <CheckBox IsChecked="{Binding Output.EnableArchiving}">
                                        Pack files into archives (recommended)
                                    </CheckBox>
                                    <ContentControl Style="{StaticResource HelpIconStyle}" Margin="8,0,0,0">
                                        <ContentControl.ToolTip>
                                            <TextBlock>
                                                Assets such as meshes and textures will be compressed and stored in archives (i.e. BSA files). This option uses much less disk
                                                space, and typically improves load times significantly. Other mods providing loose files may trigger conflicts, but this can
                                                usually be resolved by running <Run Text="{StaticResource AppName}"/> in Post-Build mode.
                                            </TextBlock>
                                        </ContentControl.ToolTip>
                                    </ContentControl>
                                </ui:SimpleStackPanel>
                                <ui:SimpleStackPanel Orientation="Horizontal">
                                    <CheckBox IsChecked="{Binding Output.EnableDewiggify}">
                                        Attempt conversion of wigs to head parts
                                    </CheckBox>
                                    <ContentControl Style="{StaticResource HelpIconStyle}" Margin="4,0,0,0">
                                        <ContentControl.ToolTip>
                                            <TextBlock>
                                                NPCs using wigs (Worn Armors with hair addons) will be converted to use real hair, if an equivalent model is available in the
                                                current load order. If no match is found, the NPC will keep their wig. Disable this option if you are merging NPC mods based
                                                on HDT-SMP, e.g. most Hair Physics patches.
                                            </TextBlock>
                                        </ContentControl.ToolTip>
                                    </ContentControl>
                                </ui:SimpleStackPanel>
                                <TextBlock Text="Texture path extraction timeout (seconds, per file)" Style="{StaticResource LoweredFormLabelStyle}"/>
                                <ui:SimpleStackPanel Orientation="Horizontal">
                                    <ui:NumberBox Width="100" Value="{Binding Output.TexturePathExtractionTimeoutSec}" Minimum="0" Maximum="300" SpinButtonPlacementMode="Compact"/>
                                    <ContentControl Style="{StaticResource HelpIconStyle}" Margin="4,0,0,0">
                                        <ContentControl.ToolTip>
                                            <TextBlock>
                                                Maximum time to spend obtaining texture paths from any given file. Limiting this helps to prevent long stalls on machines
                                                with slower (non-SSD) hard drives. Skipped files will be listed in the build metadata, so that any missing textures can be
                                                manually copied afterward. Set to 0 in order to disable the timeout; note that doing this may result in builds taking several
                                                times longer than the expected 5-15 minutes.
                                            </TextBlock>
                                        </ContentControl.ToolTip>
                                    </ContentControl>
                                </ui:SimpleStackPanel>
                                <TextBlock Text="Plugin Name" Style="{StaticResource LoweredFormLabelStyle}"/>
                                <TextBox Text="{Binding Output.PluginName, Mode=OneWay}" IsEnabled="False"/>
                                <TextBlock Foreground="{StaticResource MutedTextBrush}" Style="{StaticResource CaptionTextBlockStyle}">
                                    This is shown for your information. You can't change it.
                                </TextBlock>
                            </ui:SimpleStackPanel>
                        </Border>
                    </Expander>
                </ui:SimpleStackPanel>
            </ScrollViewer>
        </DockPanel>
    </Border>
</UserControl>
